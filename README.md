## 1. Помогатор

Учасники проекта: 
- [@ne_necoffeee](https://t.me/ne_necoffeee) Dev 4
- [@Mahmadmurod](https://t.me/Mahmadmurod) Dev 1
- [@Ufpngh5](https://t.me/Ufpngh5) Dev 3
- [@local_dan](https://t.me/local_dan) Dev 2


Проект представляет собой Telegram-бота, который позволяет пользователю взаимодействовать с AI-ассистентом. Пользователь может задавать вопросы, получать ответы, отслеживать количество доступных вопросов (ограниченных кредитов) и при необходимости пополнять их количество через интегрированные платежные методы.

Пользовательский интерфейс Telegram-бота будет реализован через меню с inline-кнопками, позволяющими перейти к отправке сообщения AI, проверке кредитов, пополнению баланса или изменению настроек. Каждое сообщение пользователя проверяется на наличие доступных кредитов, после чего отправляется на backend для обработки и пересылается в AI-сервис. Ответ модели сохраняется в базе данных и возвращается пользователю через бот.

---

## 2. Диаграммы системы

### 2.1 Основная логика бота

![Logic](https://github.com/LocalDoc/helper-bot-/blob/main/images/user%20to%20answer%20flowchart.png)

Полный цикл работы бота.
Пользователь открывает его и видит главное меню (`/start`). На этом этапе бот проверяет, есть ли у пользователя активный пробный период или подписка (`Free trial?` / `Has subscription?`). Если пробный период ещё не активирован, пользователю предлагается его активировать (`Offer free trial`). После согласия бот запускает пробный период с ограничением по количеству сообщений (`Activate free trial with limited msg`). Если пользователь уже использует пробный период, проверяется, остались ли сообщения для отправки (`Trial messages left?`). При исчерпании пробного лимита пользователю предлагается оформить подписку (`Offer subscription`).

Если пользователь отправляет сообщение для AI, бот сначала проверяет статус подписки или активного пробного периода (`Subscription active?`). Если доступ разрешён, бот переходит в состояние готовности к общению (`Ready to chat`). Пользователь отправляет сообщение, оно принимается ботом и передаётся на backend для обработки (`User sends message → Bot receives message → Send request`). Backend формирует запрос к сервисам ChatGPT, Gemini и DeepSeek, получает ответ и возвращает его пользователю. В случае возникновения ошибки система уведомляет пользователя и повторяет попытку отправки (`Retry / error message`). После успешного получения ответа AI сообщение отображается пользователю (`Send AI reply`) и сохраняется в базе данных, а также логируется взаимодействие (`Log interaction`).

Весь процесс управления пробным периодом, подпиской и кредитами осуществляется на каждом шаге перед отправкой запроса в AI, что позволяет контролировать доступ и автоматически обновлять баланс пользователя. Настройки пользователя также обрабатываются backend и сохраняются в базе данных.

---

### 2.2 Высокоуровневая архитектура системы

![Architecture](https://github.com/LocalDoc/helper-bot-/blob/main/images/high%20level%20arch.png)

На первом уровне взаимодействует пользователь через Telegram. Все сообщения, команды и действия пользователя передаются Telegram-боту. Бот обрабатывает эти входящие сообщения и передаёт их в ядро бота (Bot Core Logic), где осуществляется несколько функций: аутентификация и управление состоянием пользователя (Auth and user state handler), проверка подписки и пробного периода (Subscription and trial checker), маршрутизация сообщений в соответствующие сервисы (Message router), обработка ошибок (Error handler) и логирование действий пользователя и бота (Logging module).

Второй уровень. Сервис проверки подписки (Subscription Service) управляет доступом пользователя к функциям бота, определяет, активна ли подписка или пробный период, а также взаимодействует с платежным обработчиком (Payment Handler) для пополнения баланса. Менеджер бесплатного пробного периода (Free Trial Manager) следит за количеством доступных сообщений в пробном периоде и обновляет данные в базе. Основной AI-сервис (ChatGPT, Gemini и DeepSeek) получает текстовые сообщения от маршрутизатора и возвращает обработанные ответы пользователю через бота.

Третий уровень. Хранится вся ключевая информация: профили пользователей с Telegram ID, данные о подписках, пробных периодах и транзакциях по кредитам.

Четвёртый уровень. Backend и база данных развёрнуты на VPS-сервере, за которым установлен NGINX, выполняющий функции обратного прокси и SSL-терминации. Приложение контейнеризировано с помощью Docker, что упрощает деплой и управление зависимостями. Контейнеризированное приложение взаимодействует как с Telegram-ботом, так и с базой данных.

---

## 3. Подробное описание реализации

Реализация проекта начинается с создания Telegram-бота на базе **aiogram**, развёртывания backend-сервиса, настройки базы данных PostgreSQL и интеграции всех компонентов в единый функциональный поток. Ниже описан полный цикл разработки и то, как каждый слой системы должен работать вместе.

---

### 3.1 Создание Telegram-бота и настройка aiogram

Разработка начинается с создания нового бота через **BotFather**. После получения токена бот регистрируется на сервере через **webhook**: aiogram получает апдейты не через опрос, а через прямые HTTPS-запросы от Telegram. Приложение поднимает webhook, используя связку **Nginx → FastAPI → aiogram**, чтобы бот мог принимать сообщения в реальном времени.

Когда пользователь отправляет сообщение, aiogram не отвечает напрямую. Вместо этого:

1. Обработчик принимает апдейт.
2. Middlewares проверяют:

   * зарегистрирован ли пользователь в БД,
   * есть ли активная подписка,
   * доступен ли trial.
3. Router определяет, куда направить запрос.
4. Если сообщение требует AI-ответа, бот отправляет его на backend.
5. Aiogram ждёт результат и возвращает его пользователю.

Aiogram работает асинхронно, позволяя боту обслуживать нескольких пользователей одновременно. Асинхронность реализуется через `async`/`await`, что позволяет не блокировать event loop и обрабатывать множество запросов параллельно.

---

### 3.2 Backend-сервис на FastAPI

FastAPI отвечает за всю бизнес-логику, которую лучше не выполнять на стороне Telegram-бота.

Основные маршруты:

* `/process_message` — отправка вопроса в AI и получение ответа
* `/get_credits` — проверка текущего баланса пользователя
* `/update_credits` — списание или пополнение кредитов
* `/complete_payment` — подтверждение платежей
* `/user_profile` — выдача настроек пользователя
* `/start_trial` — активация пробного периода
* `/register` — первичная регистрация пользователя

Принцип работы:

1. Aiogram отправляет данные на backend.
2. Backend проверяет пользователя в базе данных.
3. Если запрос требует AI-ответа, backend отправляет текст в сервисы ChatGPT, Gemini или DeepSeek.
4. Полученный ответ сохраняется в базе данных.
5. Backend возвращает результат боту.

Backend обрабатывает исключения, логирует операции и взаимодействует с системой платежей.

---

### 3.3 Взаимодействие backend с PostgreSQL (асинхронный SQLAlchemy — разумный подход)

Основные таблицы:

* `users` — Telegram ID, настройки, дата регистрации
* `subscriptions` — статус подписки, даты начала/окончания
* `trials` — состояние пробного периода
* `messages_log` — история вопросов и ответов AI
* `transactions` — платежи, суммы, статусы

Пример процесса списания кредитов:

1. Backend получает `/process_message`.
2. Создаёт транзакцию через SQLAlchemy.
3. Проверяет наличие кредитов.
4. Если кредитов нет — возвращает ошибку.
5. Если есть — уменьшает их количество.
6. Отправляет текст в AI-сервисы.
7. Сохраняет вопрос и ответ в `messages_log`.
8. Коммитит транзакцию.

Всё выполняется асинхронно.

---

### 3.4 Реализация платежной системы

Баланс пополняется через **Telegram Payments**:

1. Пользователь нажимает «Пополнить баланс».
2. Aiogram отправляет `/create_payment` на backend.
3. Backend формирует invoice и возвращает его боту.
4. Пользователь оплачивает через Telegram.
5. Telegram уведомляет aiogram о `successful_payment`.
6. Aiogram передаёт данные о транзакции backend-у.
7. Backend:

   * проверяет валидность платежа,
   * создаёт запись в `transactions`,
   * пополняет баланс пользователя.
8. Aiogram уведомляет пользователя об успешной оплате.

Все транзакции логируются.

---

### 3.5 Логирование и обработка ошибок

Централизованная система логирования покрывает:

* входящие сообщения,
* ответы AI,
* операции SQLAlchemy,
* ошибки,
* платежные события.

Aiogram использует **Error Handler**, который:

* перехватывает исключения,
* отправляет информацию backend-у,
* уведомляет пользователя при необходимости,
* пишет запись в таблицу логов.

---

### 3.6 Тестирование

Необходимо осуществить unit-тесты, проверяющие:

* обработку команд и inline-кнопок,
* проверку подписки и trial,
* логирование событий,
* интеграцию с AI,
* обработку платежей.

По правилам проекта покрытие кода ≥ 65%.

---

### 3.7 Docker

Проект развёрнут через Docker и Docker Compose. Состав инфраструктуры:

* **Nginx** — reverse proxy, SSL-терминация, маршрутизация webhook
* **Backend (FastAPI)** — контейнер backend-сервиса
* **Bot (aiogram)** — обработка webhook
* **PostgreSQL** — база данных
* **Alembic** — миграции
* **Worker** — фоновые задачи, если они появятся

Схема работы:

* Nginx принимает HTTPS-запросы от Telegram,
* перенаправляет их на backend,
* backend обрабатывает логику и взаимодействует с aiogram,
* aiogram отправляет ответы пользователю,
* все события логируются и сохраняются в базе данных.

---

## 4. Распределение работы

Для эффективной реализации проекта и равномерной загрузки команды, работа распределена между четырьмя разработчиками.

**Dev 1 — Telegram-бот и интерфейс**
Первый разработчик сосредоточится на создании и настройке Telegram-бота на основе aiogram. Он отвечает за приём сообщений, обработку inline-кнопок, маршрутизацию команд и интеграцию с backend через webhook. Кроме того, этот разработчик будет обеспечивать корректную работу middlewares, которые проверяют подписку, пробный период и регистрацию пользователя, а также отвечают за асинхронную обработку сообщений.

* Настройка и регистрация бота через BotFather.
* Реализация webhook с Nginx → FastAPI → aiogram.
* Настройка router и middlewares для проверки состояния пользователя.
* Обработка команд, inline-кнопок и ошибок на стороне бота.
* Асинхронная обработка сообщений и интеграция с backend.

**Dev 2 — Backend на FastAPI**
Второй разработчик отвечает за реализацию бизнес-логики на FastAPI. Он создаёт основные маршруты API, обрабатывает запросы от бота, взаимодействует с AI-сервисами ChatGPT, Gemini и DeepSeek для генерации ответов и обеспечивает корректное сохранение данных в базу. Кроме того, он реализует обработку ошибок и логирование событий на backend.

* Реализация маршрутов `/process_message`, `/get_credits`, `/update_credits`, `/complete_payment`, `/user_profile`, `/start_trial`, `/register`.
* Взаимодействие с AI-сервисами ChatGPT, Gemini и DeepSeek.
* Обработка исключений и логирование операций.
* Проверка состояния пользователя и управление кредитами.
* Интеграция с PostgreSQL.

**Dev 3 — База данных и асинхронное взаимодействие**
Третий разработчик отвечает за настройку и управление PostgreSQL, создание схем, таблиц и миграций через Alembic. Он также отвечает за асинхронную работу с базой данных через SQLAlchemy, обработку транзакций и контроль целостности данных.

* Создание таблиц `users`, `subscriptions`, `trials`, `messages_log`, `transactions`.
* Настройка Alembic и управление миграциями.
* Реализация асинхронных операций с базой данных через SQLAlchemy.
* Контроль транзакций, списания и пополнения кредитов.
* Логирование операций и взаимодействие с backend.

**Dev 4 — Платёжная система, логирование и Docker**
Четвёртый разработчик работает с платежами, централизованным логированием и контейнеризацией проекта. Он интегрирует Telegram Payments с backend, обеспечивает корректное отражение транзакций и логирует все ключевые события. Также он подготавливает Docker и Docker Compose конфигурации для всего проекта, включая Nginx, backend, бота и базу данных.

* Платёжная система через Telegram Payments.
* Проверка валидности платежей, создание записей в `transactions` и обновление баланса.
* Настройка централизованного логирования входящих сообщений, ответов AI и ошибок.
* Развёртывание проекта через Docker и Docker Compose.
* Настройка Nginx как reverse proxy и SSL-терминации.
* Контейнеризация всех компонентов и обеспечение взаимодействия между ними.
